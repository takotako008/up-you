<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>LoiLoNote Mesh Professional</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --loilo-bg: #0b1222; 
            --loilo-sidebar: #f5f6f7;
            --loilo-blue: #1a73e8;
            --loilo-card-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }

        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: var(--loilo-bg); }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; }

        /* --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ‡ã‚¶ã‚¤ãƒ³ (ãƒ­ã‚¤ãƒ­å®Œå…¨å†ç¾) --- */
        .sidebar { width: 320px; background: var(--loilo-sidebar); display: flex; flex-direction: column; border-right: 1px solid #dcdcdc; z-index: 10; }
        .sidebar-header { padding: 25px 20px 10px; font-size: 13px; color: #5f6368; font-weight: bold; }
        .room-list { flex-grow: 1; padding: 0 12px; overflow-y: auto; }
        
        .room-card { 
            background: white; border-radius: 8px; margin-bottom: 3px; 
            padding: 14px 22px; display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.06); border: 2px solid transparent;
            transition: 0.1s; color: #3c4043; font-size: 17px;
        }
        .room-card.active { border-color: #bad3f8; background: #e8f0fe; color: var(--loilo-blue); font-weight: bold; }
        .dots { color: #d1d1d1; font-size: 20px; }

        .sidebar-footer { padding: 10px; border-top: 1px solid #ddd; }
        .footer-item { display: flex; align-items: center; gap: 12px; padding: 8px 15px; font-size: 14px; color: #3c4043; cursor: pointer; }
        .footer-blue { color: var(--loilo-blue); font-weight: bold; margin-bottom: 10px; }

        /* --- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ã¨å›è»¢ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° --- */
        .canvas { flex-grow: 1; position: relative; display: flex; flex-direction: column; }
        
        #loader-overlay {
            position: absolute; inset: 0; display: none; flex-direction: column;
            justify-content: center; align-items: center; background: var(--loilo-bg); z-index: 100;
        }

        /* GitHubç”»åƒã‚’ãã‚‹ãã‚‹å›è»¢ã•ã›ã‚‹è¨­å®š */
        .loading-img { 
            width: 120px; height: 120px; 
            animation: loilo-rotate 2s linear infinite; 
        }
        @keyframes loilo-rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .loader-text { margin-top: 25px; color: white; font-size: 14px; letter-spacing: 2px; opacity: 0.6; }

        /* --- ãƒãƒ£ãƒƒãƒˆç”»é¢ --- */
        #chat-view { display: none; flex-direction: column; height: 100%; }
        .header { padding: 18px 35px; border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; justify-content: space-between; align-items: center; color: white; }
        .status-online { color: #4ade80; font-size: 13px; display: flex; align-items: center; gap: 6px; }
        .status-dot { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; }

        #chat-log { flex-grow: 1; overflow-y: auto; padding: 40px; display: flex; flex-direction: column; gap: 30px; }
        
        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .msg { padding: 15px 20px; border-radius: 12px; max-width: 480px; font-size: 16px; position: relative; box-shadow: var(--loilo-card-shadow); word-break: break-all; }
        .msg-in { align-self: flex-start; background: white; color: #111; }
        .msg-out { align-self: flex-end; background: var(--loilo-blue); color: white; }
        .sender-tag { position: absolute; top: -22px; left: 5px; font-size: 11px; font-weight: bold; color: #64748b; }

        .system-tag { align-self: center; background: rgba(255,255,255,0.08); padding: 5px 20px; border-radius: 20px; font-size: 12px; color: #94a3b8; }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-area { background: var(--loilo-bg); padding: 20px 40px 40px; }
        .input-inner { display: flex; gap: 15px; max-width: 1100px; margin: 0 auto; }
        input { 
            flex-grow: 1; background: #1e293b; border: 1px solid #334155; padding: 14px 28px; 
            border-radius: 35px; color: white; outline: none; font-size: 16px; 
        }
        .btn-send { background: var(--loilo-blue); color: white; border: none; padding: 0 35px; border-radius: 35px; cursor: pointer; font-weight: bold; }

        #welcome { margin: auto; color: #475569; font-size: 20px; letter-spacing: 1px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">1å¹´1çµ„</div>
    <div class="room-list" id="room-list"></div>
    <div class="sidebar-footer">
        <div class="footer-item footer-blue">ï¼‹ ã‚¯ãƒ©ã‚¹å‚åŠ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</div>
        <div class="footer-item">ğŸ•’ é–‰è¬›ã—ãŸæˆæ¥­</div>
        <div class="footer-item">ğŸ”’ è‡ªä¸»å­¦ç¿’</div>
        <div class="footer-item">âœ¨ æ–°æ©Ÿèƒ½</div>
        <div class="footer-item">ğŸ“¢ ãƒ­ã‚¤ãƒ­ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›</div>
    </div>
</div>

<div class="canvas">
    <div id="welcome">æˆæ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„</div>

    <div id="loader-overlay">
        <img src="https://github.com/takotako008/up-you/blob/main/image-removebg-preview%20(11).png?raw=true" class="loading-img">
        <div class="loader-text">èª­ã¿è¾¼ã¿ä¸­</div>
    </div>

    <div id="chat-view">
        <div class="header">
            <span style="font-size: 20px; font-weight: bold;">Room <span id="room-num">-</span></span>
            <span class="status-online"><span class="status-dot"></span>Online <small id="peer-count">(1)</small></span>
        </div>
        <div id="chat-log"></div>
        <div class="input-area">
            <div class="input-inner">
                <input type="text" id="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." autocomplete="off">
                <button class="btn-send" id="send-btn">é€ä¿¡</button>
            </div>
        </div>
    </div>
</div>

<script>
    let peer = null;
    let myId = "";
    let activeRoom = null;
    let connections = {};
    let receivedMsgIds = new Set();
    let scanInterval = null;

    // ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆç”Ÿæˆ
    const roomList = document.getElementById('room-list');
    for(let i=1; i<=13; i++) {
        const div = document.createElement('div');
        div.className = 'room-card';
        div.id = `room-${i}`;
        div.innerHTML = `<span>${i}</span><span class="dots">...</span>`;
        div.onclick = () => selectRoom(i);
        roomList.appendChild(div);
    }

    function selectRoom(num) {
        if (activeRoom === num) return;
        
        document.querySelectorAll('.room-card').forEach(c => c.classList.remove('active'));
        document.getElementById(`room-${num}`).classList.add('active');
        document.getElementById('welcome').style.display = 'none';
        document.getElementById('chat-view').style.display = 'none';
        document.getElementById('loader-overlay').style.display = 'flex';

        if (peer) peer.destroy();
        if (scanInterval) clearInterval(scanInterval);
        document.getElementById('chat-log').innerHTML = '';
        connections = {};
        receivedMsgIds.clear();
        activeRoom = num;

        // æ¥ç¶šIDã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é–‹å§‹ã—ã¦ã€Œèª­ã¿è¾¼ã¿ä¸­ã€ã‚’æœ€é€Ÿã§çªç ´
        startPeer(Math.floor(Math.random() * 8));
    }

    function startPeer(index) {
        // IDã‚’ã•ã‚‰ã«çŸ­ãå®‰å®šåŒ–
        const targetId = `ln-${activeRoom}-${index.toString().padStart(4, '0')}`;
        
        peer = new Peer(targetId, {
            config: {'iceServers': [{ urls: 'stun:stun.l.google.com:19302' }]},
            debug: 1
        });

        peer.on('open', (id) => {
            myId = id;
            document.getElementById('loader-overlay').style.display = 'none';
            document.getElementById('chat-view').style.display = 'flex';
            document.getElementById('room-num').innerText = activeRoom;
            appendLog(`Room ${activeRoom} ã«å‚åŠ ã—ã¾ã—ãŸ`, "system");

            scanNeighbors();
            scanInterval = setInterval(scanNeighbors, 5000);
        });

        peer.on('error', (err) => {
            if (err.type === 'unavailable-id') {
                peer.destroy();
                startPeer(index + 1);
            }
        });

        peer.on('connection', setupConnection);
    }

    function scanNeighbors() {
        if (!peer || peer.destroyed) return;
        const myNum = parseInt(myId.split('-').pop());
        const prefix = `ln-${activeRoom}-`;
        
        const targets = [0, myNum - 1, myNum + 1].filter(n => n >= 0 && n !== myNum);
        
        targets.forEach(n => {
            const tid = prefix + n.toString().padStart(4, '0');
            if (!connections[tid]) {
                setupConnection(peer.connect(tid));
            }
        });
    }

    function setupConnection(conn) {
        conn.on('open', () => {
            if (connections[conn.peer]) return;
            connections[conn.peer] = conn;
            updatePeerCount();
            conn.send({ type: 'sync', ids: Object.keys(connections).concat(myId) });
        });

        conn.on('data', (data) => {
            if (data.type === 'sync') {
                data.ids.forEach(id => {
                    if (id !== myId && !connections[id]) setupConnection(peer.connect(id));
                });
            } else if (data.type === 'chat') {
                if (receivedMsgIds.has(data.msgId)) return;
                receivedMsgIds.add(data.msgId);
                appendLog(data.text, "in", data.sender.split('-').pop());
                broadcast(data);
            }
        });

        conn.on('close', () => {
            delete connections[conn.peer];
            updatePeerCount();
        });
    }

    function sendMessage() {
        const input = document.getElementById('message-input');
        const text = input.value.trim();
        if (!text || !myId) return;

        const msgData = {
            type: 'chat',
            msgId: myId + Date.now() + Math.random(),
            sender: myId,
            text: text
        };

        receivedMsgIds.add(msgData.msgId);
        broadcast(msgData);
        appendLog(text, "out");
        input.value = "";
    }

    function broadcast(data) {
        Object.values(connections).forEach(conn => {
            if (conn.open) conn.send(data);
        });
    }

    function appendLog(text, type, sender = "") {
        const log = document.getElementById('chat-log');
        const div = document.createElement('div');
        if (type === 'system') {
            div.className = 'system-tag';
            div.innerText = text;
        } else {
            div.className = `msg msg-${type}`;
            const label = sender ? `<span class="sender-tag">ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${sender}</span>` : '';
            div.innerHTML = label + escapeHtml(text);
        }
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
    }

    function updatePeerCount() {
        const count = Object.keys(connections).length + 1;
        document.getElementById('peer-count').innerText = `(${count})`;
    }

    function escapeHtml(str) {
        return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    document.getElementById('send-btn').onclick = sendMessage;
    document.getElementById('message-input').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
</script>
</body>
</html>
